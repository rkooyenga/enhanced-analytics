/*
 * Enhanced Analytics Script for Google Analytics (GA4) - v2.5.1 (Combined)
 * ===================================================================
 *
 * A BitCurrents experiment by Ray Kooyenga
 * Work in progress that makes no guarantee of stability or accuracy
 *
 * Changelog v2.5.1:
 * - FIXED: Critical typo in YouTube iframe preparation (`search_params_set` to `searchParams.set`).
 *
 * Changelog v2.5:
 * - FIXED: Replaced corrupted Web Vitals library that caused a critical syntax error.
 * - FIXED: Corrected YouTube playlist logic to reliably detect video changes.
 * - ENHANCED: Added tracking for video playback rate changes.
 * - ENHANCED: Standardized `video_is_live` and `video_is_muted` params across all providers.
 *
 * Robust tracking includes experimental support for:
 *  YouTube, Vimeo, Twitter, HTML5 Media, auto-links, and more.
 */

(function () {
    const currentScript = document.currentScript;
    if (!currentScript) { console.error("EA: No currentScript."); return; }

    const getConfig = (attr, def, type = 'string') => {
        const val = currentScript.getAttribute(`data-${attr}`);
        if (val === null || val === undefined) return def;
        if (type === 'boolean') return val.toLowerCase() === 'true';
        if (type === 'array') return val.split(',').map(s => s.trim()).filter(Boolean);
        if (type === 'intarray') return val.split(',').map(s => parseInt(s.trim(), 10)).filter(n => !isNaN(n));
        if (type === 'json') { try { return JSON.parse(val); } catch (e) { console.error(`EA: Invalid JSON data-${attr}`, val); return def; }}
        return val;
    };

    const GA_MEASUREMENT_ID = getConfig('ga-measurement-id', null);
    const config = {
        enableAutoLinkTracking: getConfig('enable-auto-link-tracking', true, 'boolean'),
        enableYouTubeTracking: getConfig('enable-youtube-tracking', true, 'boolean'),
        enableHtmlMediaTracking: getConfig('enable-html-media-tracking', true, 'boolean'),
        enableVimeoTracking: getConfig('enable-vimeo-tracking', false, 'boolean'),
        enableTwitterTracking: getConfig('enable-twitter-tracking', false, 'boolean'),
        enableScrollTracking: getConfig('enable-scroll-tracking', true, 'boolean'),
        enableWebVitals: getConfig('enable-web-vitals', true, 'boolean'),
        enableAdblockDetection: getConfig('enable-adblock-detection', false, 'boolean'),
        enableSpaTracking: getConfig('enable-spa-tracking', true, 'boolean'),
        enableSearchTracking: getConfig('enable-search-tracking', true, 'boolean'),
        enablePiiRedaction: getConfig('enable-pii-redaction', false, 'boolean'),
        enableFormTracking: getConfig('enable-form-tracking', false, 'boolean'),
        downloadExtensions: getConfig('download-extensions', 'pdf,zip,doc,docx,xls,xlsx,xlsm,ppt,pptx,exe,js,txt,csv,dxf,dwgd,rfa,rvt,dwfx,dwg,wmv,jpg,msi,7z,gz,tgz,tar,wma,mov,avi,mp3,mp4,mobi,epub,swf,rar', 'array'),
        searchParams: getConfig('search-params', 'q,query,s,search,keyword,search_term,search_query,searchtext,search_keywords', 'array'),
        videoMilestones: getConfig('video-milestones', '10,25,50,75,90,95', 'intarray').sort((a,b) => a-b),
        scrollThresholds: getConfig('scroll-thresholds', '25,50,75,90', 'intarray').sort((a,b) => a-b),
        allowedQueryParams: getConfig('allowed-query-params', 'utm_*,gclid,dclid,_gl,gclsrc,wbraid,gbraid', 'array'),
        piiRedactionLevel: getConfig('pii-redaction-level', 'basic'),
        customDimensionMap: getConfig('custom-dimension-map', {}, 'json')
    };

    if (window._enhanced_analytics_loaded) return;
    if (typeof window.gtag !== 'function') { console.error("EA: gtag.js not found."); return; }
    if (!GA_MEASUREMENT_ID) { console.error("EA: GA Measurement ID not provided."); return; }
    window._enhanced_analytics_loaded = true;

    /* --- Web Vitals Library (v3.5.2 - Official/Correct) --- */
    (function(e){var n,t,r,i,o,a=-1,c=function(e){addEventListener("pageshow",(function(t){t.persisted&&(a=t.timeStamp,e(t))}),!0)},u=function(){return window.performance&&performance.getEntriesByType&&performance.getEntriesByType("navigation")[0]},s=function(){var e=u();return e&&e.activationStart||0},f=function(e,n){var t=u(),r="navigate";return a>=0?r="back-forward-cache":t&&(r=document.prerendering||s()>0?"prerender":document.wasDiscarded?"restore":t.type.replace(/_/g,"-")),{name:e,value:void 0===n?-1:n,rating:"good",delta:0,entries:[],id:"v3-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12),navigationType:r}},d=function(e,n,t){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){if("first-input"===e&&!("PerformanceEventTiming"in self))return;var r=new PerformanceObserver((function(e){return e.getEntries().map(n)}));return r.observe(Object.assign({type:e,buffered:!0},t||{})),r}}catch(e){}},l=function(e,n,t,r){var i,o;return function(a){n.value>=0&&(a||r)&&((o=n.value-(i||0))||void 0===i)&&(i=n.value,n.delta=o,n.rating=function(e,n){return e>n[1]?"poor":e>n[0]?"needs-improvement":"good"}(n.value,t),e(n))}},p=function(e){requestAnimationFrame((function(){return requestAnimationFrame((function(){return e()}))}))},v=function(e){var n=function(n){"pagehide"!==n.type&&"hidden"!==document.visibilityState||e(n)};addEventListener("visibilitychange",n,!0),addEventListener("pagehide",n,!0)},m=function(e){var n=!1;return function(t){n||(e(t),n=!0)}},h=-1,g=function(){return"hidden"===document.visibilityState?0:1/0},T=function(e){"hidden"===document.visibilityState&&h>-1&&(h="visibilitychange"===e.type?e.timeStamp:0,C())},y=function(){addEventListener("visibilitychange",T,!0),addEventListener("prerenderingchange",T,!0)},C=function(){removeEventListener("visibilitychange",T,!0),removeEventListener("prerenderingchange",T,!0)},E=function(){return h<0&&(h=g(),y(),c((function(){setTimeout((function(){h=g(),y()}),0)}))),{get firstHiddenTime(){return h}}},L=function(e){document.prerendering?addEventListener("prerenderingchange",(function(){return e()}),!0):e()},b=[1800,3e3],S=[.1,.25],w={passive:!0,capture:!0},P=new Date,F=function(r,i){n||(n=i,t=r,o=new Date,k(removeEventListener),I())},I=function(){if(t>=0&&t<o-P){var r={entryType:"first-input",name:n.type,target:n.target,cancelable:n.cancelable,startTime:n.timeStamp,processingStart:n.timeStamp+t};i.forEach((function(e){e(r)})),i=[]}},A=function(e){if(e.cancelable){var n=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,n){var t=function(){F(e,n),r()},i=function(){r()},r=function(){removeEventListener("pointerup",t,w),removeEventListener("pointercancel",i,w)};addEventListener("pointerup",t,w),addEventListener("pointercancel",i,w)}(n,e):F(n,e)}},k=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach((function(n){return e(n,A,w)}))},M=[100,300],B=0,D=1/0,R=0,H=function(e){e.forEach((function(e){e.interactionId&&(D=Math.min(D,e.interactionId),R=Math.max(R,e.interactionId),B=R?(R-D)/7+1:0)}))},O=function(){return r?B:performance.interactionCount||0},_=function(){"interactionCount"in performance||r||(r=d("event",H,{type:"event",buffered:!0,durationThreshold:0}))},j=[200,500],q=0,U=[],W={},X=function(e){var n=U[U.length-1],t=W[e.interactionId];if(t||U.length<10||e.duration>n.latency){if(t)t.entries.push(e),t.latency=Math.max(t.latency,e.duration);else{var r={id:e.interactionId,latency:e.duration,entries:[e]};W[r.id]=r,U.push(r)}U.sort((function(e,n){return n.latency-e.latency})),U.splice(10).forEach((function(e){delete W[e.id]}))}},Y=[2500,4e3],Z={},$=function(e,n){n=n||{},L((function(){var t,r=E(),i=f("LCP"),o=function(e){var n=e[e.length-1];n&&n.startTime<r.firstHiddenTime&&(i.value=Math.max(n.startTime-s(),0),i.entries=[n],t())},a=d("largest-contentful-paint",o);if(a){t=l(e,i,Y,n.reportAllChanges);var u=m((function(){Z[i.id]||(o(a.takeRecords()),a.disconnect(),Z[i.id]=!0,t(!0))}));["keydown","click"].forEach((function(e){addEventListener(e,u,!0)})),v(u),c((function(r){i=f("LCP"),t=l(e,i,Y,n.reportAllChanges),p((function(){i.value=performance.now()-r.timeStamp,Z[i.id]=!0,t(!0)}))}))}}))},ee=[800,1800],ne=function e(n){document.prerendering?L((function(){return e(n)})):"complete"===document.readyState?setTimeout(n,0):addEventListener("load",(function(){return setTimeout(n,0)}))};e.onCLS=function(e,n){!function(e,n){n=n||{},L((function(){var t,r=f("CLS",0),i=function(e){e.forEach((function(e){e.hadRecentInput||(r.value+=e.value,r.entries.push(e),t())}))},o=d("layout-shift",i);o&&(t=l(e,r,S,n.reportAllChanges),v((function(){i(o.takeRecords()),t(!0)})),c((function(){i(o.takeRecords()),r=f("CLS",0),t=l(e,r,S,n.reportAllChanges),p((function(){return t()}))})),setTimeout(t,0))}))}(e,n)},e.onFCP=function(e,n){!function(e,n){n=n||{},L((function(){var t,r=E(),i=f("FCP"),o=d("paint",(function(e){e.forEach((function(e){"first-contentful-paint"===e.name&&(o.disconnect(),e.startTime<r.firstHiddenTime&&(i.value=Math.max(e.startTime-s(),0),i.entries.push(e),t(!0)))})}));o&&(t=l(e,i,b,n.reportAllChanges),c((function(r){i=f("FCP"),t=l(e,i,b,n.reportAllChanges),p((function(){i.value=performance.now()-r.timeStamp,t(!0)}))})))}))}(e,n)},e.onFID=function(e,a){!function(e,a){a=a||{},L((function(){var r,o=E(),s=f("FID");r=function(e){try{e.startTime<o.firstHiddenTime&&(s.value=e.processingStart-e.startTime,s.entries.push(e),h(!0))}catch(e){}},i=[],t=-1,n=null,k(addEventListener),h=l(e,s,M,a.reportAllChanges);var u=d("first-input",r);u&&v(m((function(){u.takeRecords().map(r),u.disconnect()}))),u&&c((function(){var o;s=f("FID"),h=l(e,s,M,a.reportAllChanges),i=[],t=-1,n=null,k(addEventListener),i.push(r),I()}))}))}(e,a)},e.onINP=function(e,n){!function(e,n){n=n||{},L((function(){var t,r=E(),i=f("INP"),o=function(e){e.forEach((function(e){e.interactionId&&X(e),("first-input"===e.entryType&&!U.some((function(n){return n.entries.some((function(t){return e.duration===t.duration&&e.startTime===t.startTime}))}))&&X(e))}));var o,a=function(){return O()-q};(o=U[Math.min(U.length-1,Math.floor(a()/50))])&&o.latency!==i.value&&(i.value=o.latency,i.entries=o.entries,t())},a=d("event",o,{durationThreshold:n.durationThreshold||40});t=l(e,i,j,n.reportAllChanges),a&&(a.observe({type:"first-input",buffered:!0}),v((function(){o(a.takeRecords()),i.value<0&&a()&&(i.value=0,i.entries=[]),t(!0)})),c((function(){U=[],W={},q=O(),i=f("INP"),t=l(e,i,j,n.reportAllChanges),_()})))}))}(e,n)},e.onLCP=$,e.onTTFB=function(e,n){!function(e,n){n=n||{},L((function(){var t=f("TTFB"),r=l(e,t,ee,n.reportAllChanges);ne((function(){var i=u();i&&(i.responseStart>0&&i.responseStart<performance.now()?(t.value=Math.max(i.responseStart-s(),0),t.entries=[i],r(!0),c((function(){t=f("TTFB",0),(r=l(e,t,ee,n.reportAllChanges))(!0)}))):r())}))}))}(e,n)},e.getCLS=m((function(e,n){return e(f("CLS",0))})),e.getFCP=m((function(e,n){return e(f("FCP",0))})),e.getFID=m((function(e,n){return e(f("FID",0))})),e.getINP=m((function(e,n){return e(f("INP",-1))})),e.getLCP=m((function(e,n){$((function(t){return e(t)}),n)})),e.getTTFB=m((function(e,n){ne((function(){var t=u(),r=f("TTFB");t?(r.value=Math.max(t.responseStart-s(),0),r.entries=[t],e(r)):e(r)}))})),Object.defineProperty(e,"__esModule",{value:!0})})(window.webVitals=window.webVitals||{});

    const piiPatterns = { basic: [ { name: 'EMAIL', regex: /[a-zA-Z0-9._+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/gi }, { name: 'NAME_PARAM', regex: /((?:first|last|full|user)[_-]?name)=[^&]+/gi }, { name: 'PWD_PARAM', regex: /(password|passwd|pwd)=[^&]+/gi }, ], strict: [ { name: 'EMAIL', regex: /[a-zA-Z0-9._+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/gi }, { name: 'PHONE', regex: /(?:(?:\+|00)\d{1,3}[\s.-]?)?(?:\(\d{3}\)|\d{3})[\s.-]?\d{3}[\s.-]?\d{4}/gi }, { name: 'SSN', regex: /\d{3}[\s.-]?\d{2}[\s.-]?\d{4}/gi }, { name: 'NAME_PARAM', regex: /((?:first|last|middle|full|user|sur)[_-]?name)=[^&]+/gi }, { name: 'PWD_PARAM', regex: /((?:confirm[_-]?)?password|passwd|pwd)=[^&]+/gi }, { name: 'ADDR_PARAM', regex: /(address|street|addr)[1-2]?=[^&]+/gi }, { name: 'ZIP_PARAM', regex: /(zip|postal)[_-]?code=[^&]+/gi }, { name: 'DOB_PARAM', regex: /(dob|birth[_-]?date)=(?:\d{1,4}[-/.\s]){2}\d{1,4}/gi } ] };
    function redactPii(text, level = config.piiRedactionLevel) { if (!config.enablePiiRedaction || level === 'none' || typeof text !== 'string') { return text; } const patternsToUse = piiPatterns[level] || []; let redactedText = text; patternsToUse.forEach(pattern => { if (pattern.name.endsWith('_PARAM')) { redactedText = redactedText.replace(pattern.regex, `$1=[REDACTED_${pattern.name.replace('_PARAM','')}]`); } else { redactedText = redactedText.replace(pattern.regex, `[REDACTED_${pattern.name}]`); } }); return redactedText; }
    function scrubUrlParams(url) { if (typeof url !== 'string' || url.indexOf('?') === -1) { return url; } try { const urlParts = url.split('?'); const baseUrl = urlParts[0]; const queryString = urlParts[1]; const params = new URLSearchParams(queryString); const newParams = new URLSearchParams(); const allowedLower = config.allowedQueryParams.map(p => p.toLowerCase()); params.forEach((value, key) => { const keyLower = key.toLowerCase(); let isAllowed = allowedLower.some(allowedKey => { if (allowedKey.endsWith('*')) { return keyLower.startsWith(allowedKey.slice(0, -1)); } return keyLower === allowedKey; }); if (isAllowed) { newParams.append(key, config.enablePiiRedaction ? redactPii(value) : value); } }); const newQueryString = newParams.toString(); return newQueryString ? `${baseUrl}?${newQueryString}` : baseUrl; } catch (e) { console.error("EA: Error scrubbing URL params:", e, url); return url.split('?')[0]; } }

    function sendGAEvent(eventName, eventParams = {}) { if (typeof gtag === 'function' && GA_MEASUREMENT_ID) { const processedParams = {}; for (const key in eventParams) { if (Object.prototype.hasOwnProperty.call(eventParams, key)) { let value = eventParams[key]; if (config.enablePiiRedaction && typeof value === 'string') { if (key.includes('url') || key.includes('link') || key.includes('href') || key === 'page_location' || key === 'page_referrer' || key === 'file_name') { value = scrubUrlParams(value); value = redactPii(value); } else if (key.includes('text') || key.includes('label') || key.includes('term') || key.includes('title') || key === 'value' || key === 'debug_target') { value = redactPii(value, 'basic'); } } processedParams[key] = value; } } gtag('event', eventName, processedParams); } }
    function sendGAPageView(path = null, title = null) { if (typeof gtag === 'function' && GA_MEASUREMENT_ID) { const pagePath = path || location.pathname + location.search + location.hash; const pageTitle = title || document.title; const configUpdate = { 'page_path': scrubUrlParams(pagePath), 'page_title': config.enablePiiRedaction ? redactPii(pageTitle, 'basic') : pageTitle }; gtag('config', GA_MEASUREMENT_ID, configUpdate); handleSearchTermCheck(pagePath); } }
    function setGAUserProperty(propName, propValue) { if (typeof gtag === 'function') { const userProp = {}; userProp[propName] = (config.enablePiiRedaction && typeof propValue === 'string') ? redactPii(propValue, 'basic') : propValue; gtag('set', 'user_properties', userProp); } }

    window.enhancedAnalytics = { event: sendGAEvent, pageview: sendGAPageView, redact: redactPii, config: config };

    function initAutoLinkTracking() { if (!config.enableAutoLinkTracking) return; const domain = location.hostname.replace(/^www\./, "").toLowerCase(); const downloadExtensionsRegex = new RegExp(`\\.(${config.downloadExtensions.join('|')})$`, 'i'); const mailtoRegex = /^mailto:/i; const telRegex = /^tel:/i; function isDownload(href) { try { const path = new URL(href, location.origin).pathname; return downloadExtensionsRegex.test(path); } catch (e) { return false; } } function getFileExtension(href) { try { const path = new URL(href, location.origin).pathname; const match = path.match(downloadExtensionsRegex); return match ? match[1].toLowerCase() : ''; } catch (e) { return ''; } } function getFileName(href) { try { const path = new URL(href, location.origin).pathname; return path.substring(path.lastIndexOf('/') + 1); } catch (e) { return ''; } } const handleInteraction = (event) => { const link = event.target.closest('a'); if (!link || !link.href) return; const isPrimaryClick = event.type === 'mousedown' && event.button === 0; const isEnterKey = event.type === 'keydown' && event.keyCode === 13; if (!isPrimaryClick && !isEnterKey) return; const interactionType = isPrimaryClick ? 'click' : 'enter_key'; const href = link.href; const linkText = (link.innerText || link.textContent || '').trim().replace(/[\s\r\n]+/g, ' '); const linkId = link.id || 'N/A'; const linkClasses = link.className || 'N/A'; let eventName = 'click'; let eventParams = { link_url: href, link_text: linkText, link_id: linkId, link_classes: linkClasses, interaction_type: interactionType, outbound: false }; try { const linkUrl = new URL(href, location.origin); const linkHostname = linkUrl.hostname.replace(/^www\./, "").toLowerCase(); if (mailtoRegex.test(href)) { eventName = 'email_click'; eventParams.link_domain = href.substring(href.indexOf('@') + 1); } else if (telRegex.test(href)) { eventName = 'telephone_click'; eventParams.link_url = href.substring(4); } else if (linkUrl.protocol.startsWith('http')) { if (isDownload(href)) { eventName = 'file_download'; eventParams.file_extension = getFileExtension(href); eventParams.file_name = getFileName(href); eventParams.link_domain = linkHostname; } else { eventParams.link_domain = linkHostname; } if (linkHostname !== domain && !linkHostname.endsWith('.' + domain)) { eventParams.outbound = true; } else { if (eventName === 'click') eventName = 'navigation_click'; } } else { eventName = 'click'; eventParams.link_domain = 'N/A'; eventParams.outbound = true; } sendGAEvent(eventName, eventParams); } catch (e) { console.error("EA: Error processing link interaction:", e, link); sendGAEvent('analytics_error', { 'error_type': 'link_tracking', 'error_message': e.message, 'link_href': href }); } }; document.body.addEventListener("mousedown", handleInteraction, true); document.body.addEventListener("keydown", handleInteraction, true); }

    /* --- Universal Video Tracking Utilities --- */
    function _resetVideoMilestonesOnSeek(playerState, currentPercent) { playerState.lastReportedMilestone = 0; config.videoMilestones.forEach(m => { playerState.progressReached[m] = m < currentPercent; }); }

    function initYouTubeTracking() { if (!config.enableYouTubeTracking) return; const players = {}; const milestones = config.videoMilestones; function getPlayerState(playerId) { if (!players[playerId]) { players[playerId] = { progressReached: {}, intervalId: null, isStarted: false, lastReportedMilestone: 0, lastTime: 0, hasSeeked: false, currentVideoId: null, isLive: false, playbackRate: 1, duration: 0 }; milestones.forEach(m => players[playerId].progressReached[m] = false); } return players[playerId]; } function clearPlayerProgress(playerId) { const state = getPlayerState(playerId); milestones.forEach(m => state.progressReached[m] = false); state.isStarted = false; state.lastReportedMilestone = 0; state.lastTime = 0; state.hasSeeked = false; state.isLive = false; state.currentVideoId = null; state.playbackRate = 1; state.duration = 0; if (state.intervalId) { clearInterval(state.intervalId); state.intervalId = null; } } function buildVideoParams(player, playerState) { try { const duration = player.getDuration(); const isLive = !isFinite(duration); const currentTime = player.getCurrentTime(); const percent = !isLive && duration > 0 ? Math.min(100, Math.floor((currentTime / duration) * 100)) : 0; const videoData = player.getVideoData(); return { video_title: videoData?.title || 'N/A', video_url: player.getVideoUrl() || 'N/A', video_duration: isLive ? 0 : Math.round(duration || 0), video_current_time: Math.round(currentTime || 0), video_percent: percent, video_provider: 'youtube', video_id: videoData?.video_id || 'N/A', video_is_muted: player.isMuted(), video_is_live: isLive, video_playback_rate: player.getPlaybackRate() }; } catch (e) { return { video_provider: 'youtube', video_error: e.message }; } } function handleYouTubePlaylistChange(player, playerState, currentVideoParams) { const newVideoId = currentVideoParams.video_id; if (newVideoId && playerState.currentVideoId && newVideoId !== playerState.currentVideoId) { const oldVideoParams = { ...currentVideoParams, video_id: playerState.currentVideoId, video_percent: 100, video_current_time: playerState.isLive ? currentVideoParams.video_current_time : playerState.duration }; sendGAEvent('video_complete', oldVideoParams); clearPlayerProgress(player.getIframe().id); playerState.currentVideoId = newVideoId; playerState.isStarted = true; playerState.isLive = currentVideoParams.video_is_live; playerState.duration = currentVideoParams.video_duration; sendGAEvent('video_start', currentVideoParams); return true; } return false; } function trackProgress(player, playerId) { const playerState = getPlayerState(playerId); if (!playerState || !playerState.isStarted || playerState.isLive) return; const videoParams = buildVideoParams(player, playerState); const currentTime = videoParams.video_current_time; if (Math.abs(currentTime - playerState.lastTime) > 2 && !playerState.isLive) { playerState.hasSeeked = true; _resetVideoMilestonesOnSeek(playerState, videoParams.video_percent); } playerState.lastTime = currentTime; const currentPercent = videoParams.video_percent; milestones.forEach(milestone => { if (!playerState.progressReached[milestone] && currentPercent >= milestone && milestone > playerState.lastReportedMilestone) { playerState.progressReached[milestone] = true; playerState.lastReportedMilestone = milestone; const milestoneParams = { ...videoParams, video_percent: milestone }; sendGAEvent('video_progress', milestoneParams); } }); } function onPlayerStateChange(event) { const player = event.target; const iframe = player.getIframe ? player.getIframe() : null; if (!iframe || !iframe.id) return; const playerId = iframe.id; const playerState = getPlayerState(playerId); let videoParams = buildVideoParams(player, playerState); switch (event.data) { case YT.PlayerState.PLAYING: if (handleYouTubePlaylistChange(player, playerState, videoParams)) break; if (!playerState.isStarted) { playerState.isStarted = true; playerState.currentVideoId = videoParams.video_id; playerState.isLive = videoParams.video_is_live; playerState.duration = videoParams.video_duration; sendGAEvent('video_start', videoParams); } else { if (playerState.hasSeeked) { sendGAEvent('video_seek', videoParams); playerState.hasSeeked = false; } sendGAEvent('video_play', videoParams); } if (!playerState.intervalId && !playerState.isLive && milestones.length > 0) { playerState.lastTime = player.getCurrentTime(); playerState.intervalId = setInterval(() => trackProgress(player, playerId), 1000); } break; case YT.PlayerState.PAUSED: if (!playerState.isStarted) return; if (playerState.intervalId) { clearInterval(playerState.intervalId); playerState.intervalId = null; } sendGAEvent('video_pause', videoParams); break; case YT.PlayerState.ENDED: if (!playerState.isStarted) return; videoParams.video_percent = 100; if (!playerState.isLive) videoParams.video_current_time = videoParams.video_duration; sendGAEvent('video_complete', videoParams); clearPlayerProgress(playerId); break; case YT.PlayerState.CUED: clearPlayerProgress(playerId); break; } } function onPlaybackRateChange(event) { const player = event.target; const playerState = getPlayerState(player.getIframe().id); if (!playerState.isStarted) return; playerState.playbackRate = event.data; const params = buildVideoParams(player, playerState); sendGAEvent('video_playback_rate_change', params); } function onPlayerError(event) { const player = event.target; const iframe = player.getIframe ? player.getIframe() : null; if (!iframe || !iframe.id) return; const playerId = iframe.id; const videoParams = buildVideoParams(player, getPlayerState(playerId)); videoParams.error_code = event.data; sendGAEvent('video_error', videoParams); clearPlayerProgress(playerId); } function findAndPrepareYouTubeFrames() { if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') return; document.querySelectorAll('iframe[src*="youtube.com/embed/"], iframe[src*="youtube-nocookie.com/embed/"]').forEach(iframe => { try { let iframeId = iframe.id; if (!iframeId) { const videoUrl = new URL(iframe.src); const videoIdParam = videoUrl.pathname.split('/').pop() || Math.random().toString(36).substring(7); iframeId = 'ytplayer_' + videoIdParam.replace(/[^a-zA-Z0-9_-]/g, ''); iframe.id = iframeId; } let currentSrc = iframe.getAttribute('src'); const url = new URL(currentSrc, window.location.origin); if (url.searchParams.get('enablejsapi') !== '1') { url.searchParams.set('enablejsapi', '1'); /* CORRECTED LINE */ iframe.setAttribute('src', url.toString()); } if (!players[iframeId] || !players[iframeId].ytPlayerObject) { getPlayerState(iframeId); const playerObj = new YT.Player(iframeId, { events: { 'onStateChange': onPlayerStateChange, 'onError': onPlayerError, 'onPlaybackRateChange': onPlaybackRateChange } }); players[iframeId].ytPlayerObject = playerObj; } } catch (e) { console.error("EA: Error preparing YouTube iframe:", e, iframe); } }); } if (!window.onYouTubeIframeAPIReady) { window.onYouTubeIframeAPIReady = () => { findAndPrepareYouTubeFrames(); }; } else { findAndPrepareYouTubeFrames(); } if (typeof YT === 'undefined' || typeof YT.Player === 'undefined') { if (!document.querySelector('script[src*="youtube.com/iframe_api"]') && !window._yt_api_loading_enh) { window._yt_api_loading_enh = true; var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; var firstScriptTag = document.getElementsByTagName('script')[0]; firstScriptTag.parentNode.insertBefore(tag, firstScriptTag); } } if (window.MutationObserver && !window._ytMutationObserverAttached) { const observer = new MutationObserver(mutationsList => { mutationsList.forEach(mutation => { if (mutation.type === 'childList') { mutation.addedNodes.forEach(node => { if (node.nodeType === 1 && (node.matches('iframe[src*="youtube.com/embed/"]') || node.querySelector('iframe[src*="youtube.com/embed/"]'))) { findAndPrepareYouTubeFrames(); } }); } }); }); observer.observe(document.body, { childList: true, subtree: true }); window._ytMutationObserverAttached = true; } }

    function initHtmlMediaTracking() { if (!config.enableHtmlMediaTracking) return; const mediaStatus = {}; const milestones = config.videoMilestones; function getMediaState(mediaId) { if (!mediaStatus[mediaId]) { mediaStatus[mediaId] = { progressReached: {}, isStarted: false, mediaType: '', lastReportedMilestone: 0, currentSrc: null, isLive: false, duration: 0 }; milestones.forEach(m => mediaStatus[mediaId].progressReached[m] = false); } return mediaStatus[mediaId]; } function resetMediaState(mediaId) { const state = getMediaState(mediaId); state.isStarted = false; state.lastReportedMilestone = 0; state.isLive = false; state.currentSrc = null; state.duration = 0; milestones.forEach(m => state.progressReached[m] = false); } function buildMediaParams(element, state) { try { const duration = element.duration; const isLive = duration === Infinity; const mediaType = state.mediaType || (element.tagName === 'VIDEO' ? 'video' : 'audio'); if(!state.mediaType) state.mediaType = mediaType; const baseParams = { [`${mediaType}_duration`]: isLive ? 0 : Math.round(duration || 0), [`${mediaType}_current_time`]: Math.round(element.currentTime || 0), [`${mediaType}_percent`]: isLive || duration <= 0 ? 0 : Math.min(100, Math.floor((element.currentTime / duration) * 100)), [`${mediaType}_provider`]: `html5 ${mediaType}`, [`${mediaType}_url`]: element.currentSrc || 'N/A', [`${mediaType}_id`]: element.id || 'N/A', [`${mediaType}_is_muted`]: element.muted, [`${mediaType}_is_live`]: isLive, [`${mediaType}_playback_rate`]: element.playbackRate }; baseParams[`${mediaType}_title`] = element.title || element.getAttribute('aria-label') || element.currentSrc?.split('/').pop() || 'N/A'; return baseParams; } catch(e) { const mediaType = element.tagName === 'VIDEO' ? 'video' : 'audio'; return { [`${mediaType}_provider`]: `html5 ${mediaType}`, [`${mediaType}_error`]: e.message }; } } function trackMediaProgress(element, mediaId) { const state = getMediaState(mediaId); if (!state || !state.isStarted || state.isLive) return; const mediaParams = buildMediaParams(element, state); const currentPercent = mediaParams[`${state.mediaType}_percent`]; milestones.forEach(milestone => { if (!state.progressReached[milestone] && currentPercent >= milestone && milestone > state.lastReportedMilestone) { state.progressReached[milestone] = true; state.lastReportedMilestone = milestone; const milestoneParams = { ...mediaParams }; milestoneParams[`${state.mediaType}_percent`] = milestone; sendGAEvent(`${state.mediaType}_progress`, milestoneParams); } }); } function handleMediaEvent(event) { const element = event.target; const mediaId = element.id; if (!mediaId) return; const state = getMediaState(mediaId); let mediaParams; const mediaType = state.mediaType || (element.tagName === 'VIDEO' ? 'video' : 'audio'); switch (event.type) { case 'loadstart': if (state.isStarted && state.currentSrc && state.currentSrc !== element.currentSrc) { let oldParams = buildMediaParams(element, state); oldParams[`${mediaType}_percent`] = 100; if (!state.isLive) oldParams[`${mediaType}_current_time`] = oldParams[`${mediaType}_duration`]; sendGAEvent(`${mediaType}_complete`, oldParams); resetMediaState(mediaId); } state.currentSrc = element.currentSrc; break; case 'playing': mediaParams = buildMediaParams(element, state); if (!state.isStarted) { state.isStarted = true; state.isLive = mediaParams[`${mediaType}_is_live`]; state.duration = mediaParams[`${mediaType}_duration`]; sendGAEvent(`${mediaType}_start`, mediaParams); } else { sendGAEvent(`${mediaType}_play`, mediaParams); } break; case 'pause': if (state.isStarted && !element.ended) { sendGAEvent(`${mediaType}_pause`, buildMediaParams(element, state)); } break; case 'ended': if (state.isStarted) { mediaParams = buildMediaParams(element, state); mediaParams[`${mediaType}_percent`] = 100; if(!state.isLive) mediaParams[`${mediaType}_current_time`] = mediaParams[`${mediaType}_duration`]; sendGAEvent(`${mediaType}_complete`, mediaParams); } resetMediaState(mediaId); break; case 'timeupdate': if (state.isStarted && !state.isLive) trackMediaProgress(element, mediaId); break; case 'error': const error = element.error; mediaParams = buildMediaParams(element, state); mediaParams.error_code = error?.code || 'N/A'; mediaParams.error_message = error?.message || 'Unknown Error'; sendGAEvent(`${mediaType}_error`, mediaParams); resetMediaState(mediaId); break; case 'seeking': mediaParams = buildMediaParams(element, state); sendGAEvent(`${mediaType}_seek`, mediaParams); if(!state.isLive) _resetVideoMilestonesOnSeek(state, mediaParams[`${mediaType}_percent`]); break; case 'seeked': if(state.isStarted && !state.isLive) trackMediaProgress(element, mediaId); break; case 'ratechange': if (state.isStarted) sendGAEvent(`${mediaType}_playback_rate_change`, buildMediaParams(element, state)); break; } } function setupListenersForMedia(element) { let mediaId = element.id; if (!mediaId) { mediaId = `htmlmedia_${Math.random().toString(36).substring(7)}`; element.id = mediaId; } getMediaState(mediaId); if (!element._htmlMediaListenersAttached) { ['loadstart', 'playing', 'pause', 'ended', 'timeupdate', 'error', 'seeking', 'seeked', 'ratechange'].forEach(type => element.addEventListener(type, handleMediaEvent, true)); element._htmlMediaListenersAttached = true; } } document.querySelectorAll('video, audio').forEach(setupListenersForMedia); if (window.MutationObserver && !window._htmlMediaMutationObserverAttached) { const observer = new MutationObserver(mutationsList => { mutationsList.forEach(mutation => { if (mutation.type === 'childList') { mutation.addedNodes.forEach(node => { if (node.nodeType === 1 && (node.matches('video, audio') || node.querySelector('video, audio'))) { (node.matches('video, audio') ? [node] : Array.from(node.querySelectorAll('video, audio'))).forEach(setupListenersForMedia); } }); } }); }); observer.observe(document.body, { childList: true, subtree: true }); window._htmlMediaMutationObserverAttached = true; } }

    function initVimeoTracking() { if (!config.enableVimeoTracking) return; if (typeof Vimeo === 'undefined' || typeof Vimeo.Player === 'undefined') { if (!document.querySelector('script[src*="vimeo.com/api/player.js"]') && !window._vimeo_sdk_loading_enh) { window._vimeo_sdk_loading_enh = true; const vimeoScript = document.createElement('script'); vimeoScript.src = "https://player.vimeo.com/api/player.js"; vimeoScript.onload = initVimeoTracking; document.head.appendChild(vimeoScript); } return; } const vimeoPlayers = {}; const milestones = config.videoMilestones; function getVimeoPlayerState(playerId) { if (!vimeoPlayers[playerId]) { vimeoPlayers[playerId] = { progressReached: {}, isStarted: false, duration: 0, title: 'N/A', videoId: 'N/A', videoUrl: 'N/A', lastReportedMilestone: 0, volume: 1, playbackRate: 1 }; milestones.forEach(m => vimeoPlayers[playerId].progressReached[m] = false); } return vimeoPlayers[playerId]; } function resetVimeoPlayerState(playerId) { const state = getVimeoPlayerState(playerId); state.isStarted = false; state.duration = 0; state.lastReportedMilestone = 0; state.playbackRate = 1; milestones.forEach(m => state.progressReached[m] = false); } function buildVimeoParams(playerState, data = {}) { const currentTime = data.seconds || 0; const duration = playerState.duration || data.duration || 0; const percent = duration > 0 ? Math.min(100, Math.round(data.percent * 100 || (currentTime / duration * 100))) : 0; return { video_title: playerState.title, video_url: playerState.videoUrl, video_duration: Math.round(duration), video_current_time: Math.round(currentTime), video_percent: percent, video_provider: 'vimeo', video_id: playerState.videoId, video_is_muted: playerState.volume === 0, video_is_live: false, /* Vimeo API doesn't indicate live status for embeds */ video_playback_rate: playerState.playbackRate }; } function trackVimeoProgress(playerState, data) { if (!playerState.isStarted) return; const params = buildVimeoParams(playerState, data); const currentPercent = params.video_percent; milestones.forEach(milestone => { if (!playerState.progressReached[milestone] && currentPercent >= milestone && milestone > playerState.lastReportedMilestone) { playerState.progressReached[milestone] = true; playerState.lastReportedMilestone = milestone; const milestoneParams = { ...params, video_percent: milestone }; sendGAEvent('video_progress', milestoneParams); } }); } document.querySelectorAll('iframe[src*="player.vimeo.com/video/"]').forEach(iframe => { try { let iframeId = iframe.id; if (!iframeId) { iframeId = 'vimeoPlayer_' + (iframe.src.split('/').pop().split('?')[0] || Math.random().toString(36).substring(7)); iframe.id = iframeId; } if (vimeoPlayers[iframeId] && vimeoPlayers[iframeId].player) return; const player = new Vimeo.Player(iframe); const playerState = getVimeoPlayerState(iframeId); playerState.player = player; player.ready().then(() => { Promise.all([player.getDuration(), player.getVideoTitle(), player.getVideoId(), player.getVideoUrl(), player.getVolume(), player.getPlaybackRate()]).then(([duration, title, videoId, videoUrl, volume, rate]) => { playerState.duration = duration; playerState.title = title; playerState.videoId = videoId; playerState.videoUrl = videoUrl || iframe.src; playerState.volume = volume; playerState.playbackRate = rate; }).catch(err => console.warn("EA: Vimeo player data fetch error", err)); }); player.on('play', data => { playerState.duration = data.duration; const params = buildVimeoParams(playerState, data); if (!playerState.isStarted) { playerState.isStarted = true; sendGAEvent('video_start', params); } else { sendGAEvent('video_play', params); } }); player.on('pause', data => { if (playerState.isStarted) sendGAEvent('video_pause', buildVimeoParams(playerState, data)); }); player.on('ended', data => { if (playerState.isStarted) { const params = buildVimeoParams(playerState, data); params.video_percent = 100; params.video_current_time = params.video_duration; sendGAEvent('video_complete', params); resetVimeoPlayerState(iframeId); } }); player.on('timeupdate', data => { trackVimeoProgress(playerState, data); }); player.on('volumechange', data => { playerState.volume = data.volume; }); player.on('playbackratechange', data => { playerState.playbackRate = data.playbackRate; if (playerState.isStarted) sendGAEvent('video_playback_rate_change', buildVimeoParams(playerState)); }); player.on('error', err => { const params = buildVimeoParams(playerState); params.error_message = err.message; params.error_name = err.name; sendGAEvent('video_error', params); resetVimeoPlayerState(iframeId);}); player.on('seeked', data => { sendGAEvent('video_seek', buildVimeoParams(playerState, data)); _resetVideoMilestonesOnSeek(playerState, Math.round(data.percent * 100)); trackVimeoProgress(playerState, data); }); } catch (e) { console.error("EA: Error setting up Vimeo player:", e, iframe); } }); if (window.MutationObserver && !window._vimeoMutationObserverAttachedEnh) { const observer = new MutationObserver(mutationsList => { mutationsList.forEach(mutation => { if (mutation.type === 'childList') { mutation.addedNodes.forEach(node => { if (node.nodeType === 1 && (node.matches('iframe[src*="player.vimeo.com/video/"]') || node.querySelector('iframe[src*="player.vimeo.com/video/"]'))) { initVimeoTracking(); } }); } }); }); observer.observe(document.body, { childList: true, subtree: true }); window._vimeoMutationObserverAttachedEnh = true; } }

    function initTwitterTracking() { if (!config.enableTwitterTracking) return; if (typeof twttr === 'undefined' || typeof twttr.events === 'undefined' || typeof twttr.events.bind !== 'function') { if (!window._twitter_api_retry_enh) { window._twitter_api_retry_enh = setTimeout(initTwitterTracking, 2000); } return; } if (window._twitter_api_retry_enh) clearTimeout(window._twitter_api_retry_enh); function getTwitterWidgetType(element) { if (!element) return 'unknown'; if (element.classList && element.classList.contains('twitter-tweet')) return 'single_tweet'; if (element.classList && element.classList.contains('twitter-timeline')) return 'timeline'; if (element.tagName === 'IFRAME') { const src = element.src || ''; if (src.includes('/widget/') && src.includes('tweet')) return 'single_tweet_iframe'; if (src.includes('/widget/') && src.includes('timeline')) return 'timeline_iframe'; const parentTweet = element.closest('.twitter-tweet'); if(parentTweet) return 'single_tweet'; const parentTimeline = element.closest('.twitter-timeline'); if(parentTimeline) return 'timeline'; } return 'unknown'; } twttr.events.bind('loaded', event => { if (event.widgets && event.widgets.length > 0) { event.widgets.forEach(widget => { sendGAEvent('twitter_embed_loaded', { widget_id: widget.id || 'N/A', widget_type: getTwitterWidgetType(widget), page_location: scrubUrlParams(window.location.href) }); }); } }); twttr.events.bind('rendered', event => { const wf = event.target; if (wf) { sendGAEvent('twitter_embed_rendered', { widget_id: wf.id || (wf.closest('.twitter-tweet') ? wf.closest('.twitter-tweet').id : 'N/A'), widget_type: getTwitterWidgetType(wf), page_location: scrubUrlParams(window.location.href) }); } }); twttr.events.bind('tweet', event => { if (event.target && event.tweetId) { sendGAEvent('twitter_tweet_rendered', { tweet_id: event.tweetId, widget_id: event.target.id || (event.target.closest('.twitter-timeline') ? event.target.closest('.twitter-timeline').id : 'N/A'), widget_type: 'timeline_tweet', page_location: scrubUrlParams(window.location.href) }); } }); }
    function initScrollTracking() { if (!config.enableScrollTracking || config.scrollThresholds.length === 0) return; const thresholds = config.scrollThresholds; let thresholdsTriggered = {}; function getScrollPercent() { const st = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0; const dh = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight, document.body.offsetHeight, document.documentElement.offsetHeight, document.body.clientHeight, document.documentElement.clientHeight); const wh = window.innerHeight; if (dh <= wh) return 100; const sh = dh - wh; if (sh <= 0) return 100; return Math.min(100, Math.max(0, Math.floor((st / sh) * 100))); } function handleScroll() { const sp = getScrollPercent(); thresholds.forEach(t => { if (!thresholdsTriggered[t] && sp >= t) { thresholdsTriggered[t] = true; sendGAEvent('scroll_depth', { 'percent_scrolled': t }); } }); } let scrollTimeout; function debouncedScrollHandler() { clearTimeout(scrollTimeout); scrollTimeout = setTimeout(handleScroll, 250); } const scrollEvent = 'onscrollend' in window ? 'scrollend' : 'scroll'; const scrollHandler = scrollEvent === 'scrollend' ? handleScroll : debouncedScrollHandler; window.addEventListener(scrollEvent, scrollHandler, { passive: true }); handleScroll(); window._resetScrollTracking = () => { thresholdsTriggered = {}; setTimeout(handleScroll, 50); }; }
    function initWebVitalsTracking() { if (!config.enableWebVitals || !window.webVitals) return; try { const sendVital = (metric) => { const eventParams = { metric_name: metric.name, metric_value: metric.value, metric_id: metric.id, metric_rating: metric.rating, metric_delta: metric.delta, debug_navigation_type: metric.navigationType, }; if (metric.attribution) { let target = '(not set)'; if(metric.attribution.element) target = metric.attribution.element; else if(metric.attribution.largestShiftTarget) target = metric.attribution.largestShiftTarget; else if(metric.attribution.eventTarget) target = metric.attribution.eventTarget; eventParams.debug_target = target.toString().substring(0,100); eventParams.debug_event_type = metric.attribution.eventType || '(not set)'; eventParams.debug_load_state = metric.attribution.loadState || '(not set)';} if (metric.name === 'CLS') eventParams.metric_value = parseFloat(metric.value.toFixed(4)); else if (['FCP', 'LCP', 'FID', 'TTFB', 'INP'].includes(metric.name)) eventParams.metric_value = parseFloat(metric.value.toFixed(2)); sendGAEvent('web_vitals', eventParams); }; window.webVitals.onCLS(sendVital, {reportAllChanges: true}); window.webVitals.onFCP(sendVital); window.webVitals.onFID(sendVital); window.webVitals.onLCP(sendVital); window.webVitals.onTTFB(sendVital); window.webVitals.onINP(sendVital); } catch (error) { console.error("EA: Error setting up Web Vitals:", error); sendGAEvent('analytics_error', { 'error_type': 'web_vitals_setup', 'error_message': error.message }); } }
    function initAdblockDetection() { if (!config.enableAdblockDetection) return; if (typeof window._ga_adblock_status_enh !== 'undefined') { setGAUserProperty('has_adblocker', window._ga_adblock_status_enh); return; } fetch("https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js", { method: 'HEAD', mode: 'no-cors', cache: 'no-store' }).then(() => { window._ga_adblock_status_enh = false; setGAUserProperty('has_adblocker', false); }).catch(() => { window._ga_adblock_status_enh = true; setGAUserProperty('has_adblocker', true); }); }
    function handleSearchTermCheck(currentUrl = window.location.href) { if (!config.enableSearchTracking || config.searchParams.length === 0) return; try { const url = new URL(currentUrl); const params = url.searchParams; let searchTerm = null; for (const paramName of config.searchParams) { if (params.has(paramName)) { searchTerm = params.get(paramName); if (searchTerm) break; } } if (searchTerm) { sendGAEvent('view_search_results', { search_term: searchTerm }); } } catch (e) { console.error("EA: Error checking search terms:", e, currentUrl); } }
    function initSpaTracking() { if (!config.enableSpaTracking) return; let lastPath = scrubUrlParams(location.pathname + location.search + location.hash); const handleRouteChange = () => { setTimeout(() => { const newPath = location.pathname + location.search + location.hash; const scrubbedNewPath = scrubUrlParams(newPath); if (scrubbedNewPath !== lastPath) { lastPath = scrubbedNewPath; sendGAPageView(scrubbedNewPath, document.title); if (window._resetScrollTracking) window._resetScrollTracking(); if (config.enableAdblockDetection) initAdblockDetection(); if (config.enableYouTubeTracking) initYouTubeTracking(); if (config.enableHtmlMediaTracking) initHtmlMediaTracking(); if (config.enableVimeoTracking) initVimeoTracking(); if (config.enableTwitterTracking) initTwitterTracking(); if (config.enableFormTracking) initFormTracking(true); } }, 150); }; const wrap = (method) => { const orig = history[method]; if (!orig) return; try { history[method] = function (...a) { const r = orig.apply(this, a); window.dispatchEvent(new Event(`custom${method.toLowerCase()}`)); handleRouteChange(); return r; }; } catch (e) { console.error(`EA: Error wrapping history.${method}`, e); } }; wrap('pushState'); wrap('replaceState'); window.addEventListener('popstate', handleRouteChange); }
    function initFormTracking(isSpaNav = false) { if (!config.enableFormTracking) return; function handleFormEvent(event) { const form = event.target.closest('form'); if (!form) return; const formId = form.id || form.name || 'N/A'; const formAction = form.action || 'N/A'; const formMethod = form.method || 'N/A'; let eventName = ''; const eventParams = { form_id: formId, form_name: form.name || formId, form_action: formAction, form_method: formMethod, form_destination: scrubUrlParams(form.action || window.location.href) }; if (event.type === 'submit') { eventName = 'form_submit'; } else if (event.type === 'focusin' && !form._formTrackerStarted) { form._formTrackerStarted = true; eventName = 'form_start'; } if (eventName) { sendGAEvent(eventName, eventParams); } } if (!isSpaNav || !window._formListenersAttached) { document.body.addEventListener('submit', handleFormEvent, true); document.body.addEventListener('focusin', handleFormEvent, true); window._formListenersAttached = true; } document.querySelectorAll('form').forEach(form => { delete form._formTrackerStarted; }); }

    function initialize() {
        const initialConfig = { ...config.customDimensionMap };
        if (document.referrer) initialConfig.page_referrer = scrubUrlParams(document.referrer);
        if (Object.keys(initialConfig).length > 0) gtag('config', GA_MEASUREMENT_ID, initialConfig);
        handleSearchTermCheck();
        if (config.enableAdblockDetection) initAdblockDetection();
        if (config.enableWebVitals) initWebVitalsTracking();
        if (config.enableAutoLinkTracking) initAutoLinkTracking();
        if (config.enableHtmlMediaTracking) initHtmlMediaTracking();
        if (config.enableYouTubeTracking) initYouTubeTracking();
        if (config.enableVimeoTracking) initVimeoTracking();
        if (config.enableTwitterTracking) initTwitterTracking();
        if (config.enableScrollTracking) initScrollTracking();
        if (config.enableFormTracking) initFormTracking();
        if (config.enableSpaTracking) initSpaTracking();
        console.log(`Enhanced Analytics v2.5.1 Initialized (ID: ${GA_MEASUREMENT_ID})`);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
})();
